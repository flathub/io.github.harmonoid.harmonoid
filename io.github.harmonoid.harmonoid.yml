app-id: io.github.harmonoid.harmonoid
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
rename-icon: harmonoid
rename-appdata-file: harmonoid.appdata.xml
rename-desktop-file: harmonoid.desktop
command: harmonoid
separate-locales: false
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --share=network
  - --device=dri
  - --filesystem=xdg-music
  - --talk-name=org.freedesktop.Notifications
  - --own-name=com.alexmercerind.harmonoid
modules:
  - name: libmpv
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share/man
    buildsystem: simple
    build-commands:
      - python3 waf configure --prefix=/app --enable-libmpv-shared --disable-cplayer --disable-build-date --disable-alsa
      - python3 waf build
      - python3 waf install
    sources:
      - type: archive
        url: 'https://github.com/mpv-player/mpv/archive/refs/tags/v0.34.1.tar.gz'
        sha256: '32ded8c13b6398310fa27767378193dc1db6d78b006b70dbcbd3123a1445e746'
      - type: file
        url: 'https://waf.io/waf-2.0.23'
        sha256: '28a2e4583314a162cfcbffefb8a9202c1d7869040d30b5852da479b76d9c0491'
        dest-filename: waf
    modules:
      - name: luajit
        no-autogen: true
        cleanup:
          - /bin
          - /lib/*.a
          - /include
          - /lib/pkgconfig
          - /share/man
        sources:
          - type: archive
            url: 'https://luajit.org/download/LuaJIT-2.1.0-beta3.tar.gz'
            sha256: '1ad2e34b111c802f9d0cdf019e986909123237a28c746b21295b63c9e785d9c3'
          - type: shell
            commands:
              - sed -i 's|/usr/local|/app|' ./Makefile

      - name: libv4l2
        cleanup:
          - /sbin
          - /bin
          - /include
          - /lib/*.la
          - /lib/*/*.la
          - /lib*/*/*/*.la
          - /lib/pkgconfig
          - /share/man
        config-opts:
          - '--disable-static'
          - '--disable-bpf'
          - '--with-udevdir=/app/lib/udev'
        sources:
          - type: archive
            url: 'https://linuxtv.org/downloads/v4l-utils/v4l-utils-1.22.1.tar.bz2'
            sha256: '65c6fbe830a44ca105c443b027182c1b2c9053a91d1e72ad849dfab388b94e31'

      - name: nv-codec-headers
        cleanup:
          - '*'
        no-autogen: true
        make-install-args:
          - PREFIX=/app
        sources:
          - type: archive
            url: 'https://github.com/FFmpeg/nv-codec-headers/releases/download/n11.1.5.1/nv-codec-headers-11.1.5.1.tar.gz'
            sha256: 'a28cdde3ac0e9e02c2dde7a1b4de5333b4ac6148a8332ca712da243a3361a0d9'

      - name: ffmpeg
        cleanup:
          - /include
          - /lib/pkgconfig
          - /share/ffmpeg/examples
        config-opts:
          - '--enable-shared'
          - '--disable-static'
          - '--enable-gnutls'
          - '--enable-gpl'
          - '--disable-doc'
          - '--disable-programs'
          - '--disable-encoders'
          - '--disable-muxers'
          - '--enable-encoder=png,libwebp'
          - '--enable-libv4l2'
          - '--enable-libdav1d'
          - '--enable-libfontconfig'
          - '--enable-libfreetype'
          - '--enable-libopus'
          - '--enable-librsvg'
          - '--enable-libvpx'
          - '--enable-libmp3lame'
          - '--enable-libwebp'
        sources:
          - type: archive
            url: 'https://ffmpeg.org/releases/ffmpeg-4.4.1.tar.gz'
            sha256: '82c98f74777f623710b72f9a3389fd38c1ed93bc661107e65df19234e395f6b9'

      - name: libass
        cleanup:
          - /include
          - /lib/*.la
          - /lib/pkgconfig
        config-opts:
          - '--disable-static'
        sources:
          - type: archive
            url: 'https://github.com/libass/libass/releases/download/0.15.2/libass-0.15.2.tar.gz'
            sha256: '1b2a54dda819ef84fa2dee3069cf99748a886363d2adb630fde87fe046e2d1d5'

      - name: uchardet
        buildsystem: cmake-ninja
        config-opts:
          - '-DCMAKE_BUILD_TYPE=Release'
          - '-DBUILD_STATIC=0'
        cleanup:
          - /bin
          - /include
          - /lib/pkgconfig
          - /share/man
        sources:
          - type: archive
            url: 'https://gitlab.freedesktop.org/uchardet/uchardet/-/archive/v0.0.7/uchardet-v0.0.7.tar.gz'
            sha256: 'f3635d1d10e1470452bc42c1bf509451a9926b399a11740a9949e86069d69f58'

  - name: harmonoid
    buildsystem: simple
    build-commands:
      - cp -R harmonoid/usr/bin/ /app/harmonoid
      - cp -R harmonoid/usr/share/ /app/
      - sed -i 's/<id>harmonoid/<id>io.github.harmonoid.harmonoid/' /app/share/metainfo/harmonoid.appdata.xml
      - mkdir -p /app/bin/
      - ln -s /app/harmonoid/harmonoid /app/bin/harmonoid
    sources:
      - type: archive
        only-arches:
          - x86_64
        url: https://github.com/harmonoid/harmonoid/releases/download/v0.2.0/harmonoid-linux-x86_64.tar.gz
        dest: harmonoid
        sha256: fb0f88233bf0858f6e49e2c2c8c6beb6ab25549dbb79cabee89ab6a7ece655eb
        x-checker-data:
          type: json
          url: https://api.github.com/repos/harmonoid/harmonoid/releases/latest
          version-query: .tag_name
          url-query: .assets[]  | select(.name=="harmonoid-linux-x86_64.tar.gz") |
            .browser_download_url
      - type: file
        path: harmonoid.png
